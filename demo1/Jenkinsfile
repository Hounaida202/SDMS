pipeline {
    agent any

    environment {
        DOCKERHUB_CREDENTIALS = 'hounaida202'  // ID des credentials dans Jenkins
        IMAGE_NAME = 'hounaida202/demo1-app'
        SONAR_TOKEN = '81b9323901c5b4fffb0a0adfe88b79e178a92f42'
    }

    stages {
        stage('Build & Tests') {
            steps {
                dir('demo1') {
                    bat 'mvn clean compile test'
                    bat 'mvn jacoco:report'
                }
            }
        }

        stage('Code Quality - SonarQube') {
            steps {
                dir('demo1') {
                    // Sur Windows, utiliser %VARIABLE% pas ${VARIABLE}
                    bat 'mvn org.sonarsource.scanner.maven:sonar-maven-plugin:3.11.0.3922:sonar -Dsonar.login=%SONAR_TOKEN%'
                }
            }
        }

        stage('Package JAR') {
            steps {
                dir('demo1') {
                    bat 'mvn package -DskipTests'
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                dir('demo1') {
                    // Utiliser les variables d'environnement Jenkins
                    bat "docker build -t %IMAGE_NAME%:latest -t %IMAGE_NAME%:%BUILD_NUMBER% ."
                }
            }
        }

        stage('Push to Docker Hub') {
            steps {
                dir('demo1') {
                    script {
                        withCredentials([usernamePassword(
                            credentialsId: DOCKERHUB_CREDENTIALS,
                            passwordVariable: 'DOCKER_PASSWORD',
                            usernameVariable: 'DOCKER_USERNAME'
                        )]) {
                            bat """
                                echo %DOCKER_PASSWORD% | docker login -u %DOCKER_USERNAME% --password-stdin
                                docker push %IMAGE_NAME%:latest
                                docker push %IMAGE_NAME%:%BUILD_NUMBER%
                            """
                        }
                    }
                }
            }
        }

        stage('Deploy') {
            steps {
                dir('demo1') {
                    bat '''
                        docker-compose down || echo "No containers to stop"
                        docker-compose up -d

                        REM Attendre 15 secondes
                        echo Waiting for containers to start...
                        ping -n 15 127.0.0.1 > nul

                        REM Vérifier l'état
                        docker-compose ps

                        REM Vérifier les logs
                        docker logs demo1-app-1 --tail 20

                        REM Vérifier la santé (avec gestion d'erreur)
                        curl http://localhost:8080/actuator/health || (
                            echo "Health check failed, but continuing..."
                            echo "Showing container logs:"
                            docker-compose logs --tail=10
                        )
                    '''
                }
            }
        }
    }

    post {
        always {
            echo 'Pipeline terminé'
            dir('demo1') {
                // Nettoyer seulement le build cache, pas les images
                bat 'docker builder prune -f || echo "Cleanup failed"'
            }
        }
        success {
            echo 'SUCCÈS : Tout est OK !'
            script {
                // Vérifier que l'email est configuré dans Jenkins
                emailext (
                    subject: "Build ${JOB_NAME} - ${BUILD_NUMBER} SUCCÈS",
                    body: """Le pipeline Jenkins a réussi.

Détails :
- Job: ${JOB_NAME}
- Build: ${BUILD_NUMBER}
- Image: ${IMAGE_NAME}:${BUILD_NUMBER}
- URL Build: ${BUILD_URL}

Consultez SonarQube pour les métriques qualité.""",
                    to: 'etrichih@gmail.com'  // Votre email
                )
            }
        }
        failure {
            echo 'ÉCHEC : Vérifiez les logs'
            script {
                emailext (
                    subject: "Build ${JOB_NAME} - ${BUILD_NUMBER} ÉCHEC",
                    body: "Le pipeline Jenkins a échoué.\n\nConsultez les logs: ${BUILD_URL}",
                    to: 'etrichih@gmail.com'
                )
            }
        }
    }
}